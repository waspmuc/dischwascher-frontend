<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>Dishwasher Monitor</title>
    <style>
        .fit {
            width: 73%;
            heigth: auto;
            display: block;
            margin-left: auto;
            margin-right: auto;
            margin-top: 10px;
        }

        .loader {
            width: 20%;
            heigth: auto;
            display: block;
            margin-left: auto;
            margin-right: auto;
            margin-top: 250px;
        }

    </style>
</head>
<body>
<div id="show-free" style="display:none">
    <img src="images/free.jpg" alt="Free" class="fit">
</div>
<div id="show-busy" style="display:none">
    <img src="images/busy.jpg" alt="Busy" class="fit">
</div>
<div id="show-ausraumen" style="display:none">
    <img src="images/ausraumen.jpg" alt="ausraumen" class="fit">
</div>
<div id="loading" style="display:block">
    <img src="images/connecting.gif" width="200" alt="Busy" class="loader">
</div>

<script src="lib/jquery-3.1.1.js"></script>
<script src='lib/state-machine.js'></script>
<script>


    var dishwasherEmptied //hold state of tiltswitch sensor
    var reloadTime = 3500;

    var fsm = new StateMachine({
        init: 'stop',
        transitions: [
            {name: 'running', from: 'stop', to: 'start'},
            {name: 'running', from: 'start', to: 'start'},
            {name: 'waiting', from: 'start', to: 'cleanup'},
            {name: 'waiting', from: 'cleanup', to: 'cleanup'},
            {name: 'ending', from: 'cleanup', to: 'stop'},
            {name: 'ending', from: 'stop', to: 'stop'},
            {name: 'resetting', from: 'stop', to: 'stop'},
            {name: 'resetting', from: 'start', to: 'stop'},
            {name: 'resetting', from: 'cleanup', to: 'stop'}
        ],
        methods: {
            onRunning: function () {
                console.log('Dishwasher started')
                $("#show-busy").show();
                $("#show-free").hide();
                $("#show-ausraumen").hide();
                $("#loading").hide();
            },
            onWaiting: function () {
                console.log('Dishwasher is done and waits to get emptied')
                $("#show-ausraumen").show();
                $("#show-free").hide();
                $("#show-busy").hide();
                $("#loading").hide();
            },
            onEnding: function () {
                console.log('Dishwasher is emptied and ready for a new run')
                $("#show-free").show();
                $("#show-busy").hide();
                $("#show-ausraumen").hide();
                $("#loading").hide();
            },

            onInvalidTransition: function (transition, from, to) {
                console.error("transition not allowed from state '" + from + "'."
                )
            }
        }
    });

    $(document).ready(function () {

        function init() {
            fsm.ending() // reset state machine on refresh
        }

        (function worker() {

            $.ajax({
                url: 'http://localhost:10010/api/device/tiltswitchsensor', //Mock
                //url: 'http://192.168.40.101:3011/sensor',
                dataType: 'json',
                timeout: 3000,
                method: 'GET',
                success: function (data) {

                    var response = JSON.parse(data);
                    //console.log("response.recentState is: " + response.recentState)
                    //console.log("response.lastChanged is: " + response.lastChanged)
                    if (response.recentState == 'true' && response.lastChanged >= 15) {
                        dishwasherEmptied = true;
                      //  console.log("dishwasherEmptied is: " + dishwasherEmptied);
                    }
                    else
                        dishwasherEmptied = false;
                },
                error: function (xhr, status, error) {
                    $("#loading").show();
                    $("#show-free").hide();
                    $("#show-busy").hide();
                    $("#show-ausraumen").hide();
                    console.error("Request error: " + status);
                }
            });


            $.ajax({
                //url: 'http://192.168.40.101/api/device/wemodischwascher',
                url: 'http://localhost:10010/api/device/wemodischwascher',
                dataType: 'json',
                timeout: 3000,
                method: 'GET',
                success: function (data) {

                    //on each success
                    var response = JSON.parse(data);
                    $("#loading").hide();
                    //console.log("Json is: " + response.wemodishwasher.currentpower)

                    if (response.wemodishwasher.currentpower > 1000) { //busy if > 7,30 Watt
                        console.log("Dishwasher is on with current power " + response.wemodishwasher.currentpower + " Milliwatt")
                        console.log("Transit from state '" + fsm.state + "' to 'start'")
                        fsm.running()
                    }

                    //Todo: Implement "not changed since x seconds" in Tilt-Switch-Sensor Service
                    else if ((response.wemodishwasher.currentpower < 400) && (dishwasherEmptied == false) && (fsm.state != "stop")) {
                        console.log("Dishwasher is done and running with " + response.wemodishwasher.currentpower + " Milliwatt.")
                        console.log("Transit from state '" + fsm.state + "' to 'cleanup'")
                        fsm.waiting()
                    }
                    else if ((response.wemodishwasher.currentpower < 400) && (dishwasherEmptied == true)) {
                        console.log("Dishwasher is not runnning with current power " + response.wemodishwasher.currentpower + " Milliwatt.")
                        console.log("Transit from state '" + fsm.state + "' to 'stop'")
                        fsm.ending()
                    }
                    else
                        fsm.ending();
                },
                error: function (xhr, status, error) {
                    $("#loading").show();
                    $("#show-free").hide();
                    $("#show-busy").hide();
                    $("#show-ausraumen").hide();
                    console.error("Request error: " + status);
                }
            });
            //Todo: Increase timeout, when power consumption increases the first time over 1000 Watt
            setTimeout(worker, reloadTime);
        })();
    });
</script>
</body>
</html>
