<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>Dishwasher Monitor</title>
    <style>
        .fit {
            width: 73%;
            heigth: auto;
            display: block;
            margin-left: auto;
            margin-right: auto;
            margin-top: 10px;
        }

        .loader {
            width: 20%;
            heigth: auto;
            display: block;
            margin-left: auto;
            margin-right: auto;
            margin-top: 250px;
        }

    </style>
</head>
<body>
<div id="show-free" style="display:none">
    <img src="images/free.jpg" alt="Free" class="fit">
</div>
<div id="show-busy" style="display:none">
    <img src="images/busy.jpg" alt="Busy" class="fit">
</div>
<div id="show-ausraumen" style="display:none">
    <img src="images/ausraumen.jpg" alt="ausraumen" class="fit">
</div>
<div id="loading" style="display:block">
    <img src="images/connecting.gif" width="200" alt="Busy" class="loader">
</div>

<script src="lib/jquery-3.1.1.js"></script>
<script src='lib/state-machine.js'></script>
<script>


    var CONST_DEFAULT_RELOAD_TIME = 1500; //1,5 Sekunden
    var CONST_RUNNING_RELOAD_TIME = 1500; //1,5 Sekunden
    var CONST_THRESHHOLD_CONSUMPTION_NOT_RUNNING = 750;
    var CONST_TIMEWINDOW_FOR_CANCEL_START_IN_SECONDS = 10;
    var CONST_TIMEWINDOW_FOR_ASSUMING_DISHWASHER_IS_EMPTIED = 15;
    var CONST_RECORDING_INTERVAL_PREVIOUS_POWERCONSUMPTION = 15 * 1000; // 600000 = 10 minutes

    var dishwasherEmptied = false; //hold state of tiltswitch sensor
    var startTime = 0; //Starttime of washing process
    var currentPower = 0; //most recent power consumption
    var previousPower = 0; //previous recorded power consumption
    var reloadTime = CONST_DEFAULT_RELOAD_TIME; //Time period, when data is fetched regularly

    function init() {
        fsm.end() // reset state machine on refresh
    }

    function isRunCancellable() {
        if (getCurrentTimeInSeconds() <= startTime + CONST_TIMEWINDOW_FOR_CANCEL_START_IN_SECONDS)
            return true;
        else
            return false;
    }

    function getCurrentTimeInSeconds() {
        return Math.round(new Date() / 1000);
    }

    setInterval(function () {
        storePowerInformation()
    }, CONST_RECORDING_INTERVAL_PREVIOUS_POWERCONSUMPTION);

    function storePowerInformation() {
        console.log("Storing power consumption information. PreviousPower: " + previousPower + " currentPower: " + currentPower)
        previousPower = currentPower;
    }

    var fsm = new StateMachine({
        init: 'stopped',
        transitions: [
            {name: 'start', from: 'stopped', to: 'started'},
            {name: 'cleanup', from: 'started', to: 'cleaned'},
            {name: 'cleanup', from: 'cleaned', to: 'cleaned'},
            {name: 'end', from: 'cleaned', to: 'stopped'},
            {name: 'end', from: 'stopped', to: 'stopped'},
            {name: 'reset', from: 'stopped', to: 'stopped'},
            {name: 'reset', from: 'started', to: 'stopped'},
            {name: 'reset', from: 'cleaned', to: 'stopped'}
        ],
        methods: {
            onStart: function () {
                console.log('Dishwasher started');
                reloadTime = CONST_RUNNING_RELOAD_TIME;
                startTime = getCurrentTimeInSeconds()
                $("#show-busy").show();
                $("#show-free").hide();
                $("#show-ausraumen").hide();
                $("#loading").hide();
            },
            onCleanup: function () {
                console.log('Dishwasher is done and waits to get emptied')
                $("#show-ausraumen").show();
                $("#show-free").hide();
                $("#show-busy").hide();
                $("#loading").hide();
            },
            onEnd: function () {
                console.log('Dishwasher is emptied and ready for a new run')
                $("#show-free").show();
                $("#show-busy").hide();
                $("#show-ausraumen").hide();
                $("#loading").hide();
            },

            onInvalidTransition: function (transition, from, to) {
                console.error("transition not allowed from state '" + from + "'."
                )
            }
        }
    });


    $(document).ready(function () {


        init();

        console.log("Current state is: " + fsm.state);
        (function worker() {

            $.ajax({
                //url: 'http://localhost:10010/api/device/tiltswitchsensor', //Mock Development
                url: 'http://192.168.40.101/api/tiltswitchsensorservice/',
                dataType: 'json',
                timeout: 6000,
                method: 'GET',
                success: function (response) {

                    //var response = data;
                    console.log("response.currentState is: " + response.currentState)
                    console.log("response.lastChanged is: " + response.lastChanged)

                    if (response.currentState == true && response.lastChanged >= CONST_TIMEWINDOW_FOR_ASSUMING_DISHWASHER_IS_EMPTIED) {
                        dishwasherEmptied = true;
                          console.log("dishwasherEmptied is: " + dishwasherEmptied);
                    }
                    else {
                        dishwasherEmptied = false;
                        console.log("dishwasherEmptied is: " + dishwasherEmptied);
                    }

                },
                error: function (xhr, status, error) {
//                    $("#loading").show();
//                    $("#show-free").hide();
//                    $("#show-busy").hide();
//                    $("#show-ausraumen").hide();
                    console.error("Request error: " + status);
                }
            });


            $.ajax({
                url: 'http://192.168.40.101/api/device/wemodischwascher',
                //url: 'http://localhost:10010/api/device/wemodischwascher', //Mock Developmen
                dataType: 'json',
                timeout: 3000,
                method: 'GET',
                success: function (response) {

                    //on each success
                    //var response = JSON.parse(data);
                    $("#loading").hide();
                    currentPower = response.currentpower;
                    //console.log("Jsonresponse is: " + JSON.stringify(response))


                    //console.log("IsInTime: " + isWithinTimeWindow());

                    if (currentPower > CONST_THRESHHOLD_CONSUMPTION_NOT_RUNNING) {
                        console.log("Dishwasher is on with current power " + currentPower + " Milliwatt");
                        console.log("Transit from state '" + fsm.state + "' to 'started'");
                        fsm.start()
                    }

                    else if (currentPower < CONST_THRESHHOLD_CONSUMPTION_NOT_RUNNING && isRunCancellable()) { //Reset unintended run
                        console.log("Reset app");
                        fsm.cleanup();
                        fsm.end();
                        location.reload();
                    }

                    else if ((currentPower < CONST_THRESHHOLD_CONSUMPTION_NOT_RUNNING) && (previousPower < CONST_THRESHHOLD_CONSUMPTION_NOT_RUNNING)) {
                        if ((dishwasherEmptied == false) && (fsm.state != "stopped")) {
                            console.log("Dishwasher is done and running with " + response.currentpower + " Milliwatt.")
                            console.log("Transit from state '" + fsm.state + "' to 'cleaned'")
                            fsm.cleanup()
                        }
                    }
                    else
                        console.log("No condition satisfies")

                    if (dishwasherEmptied == true) {
                        console.log("Dishwasher is not runnning with current power " + response.currentpower + " Milliwatt.")
                        console.log("Transit from state '" + fsm.state + "' to 'stopped'")
                        fsm.end()
                    }
                },
                error: function (xhr, status, error) {
                    $("#show-free").hide();
                    $("#show-busy").hide();
                    $("#show-ausraumen").hide();
                    $("#loading").show();
                    console.error("Request error: " + status);
                }
            });
            setTimeout(worker, reloadTime);
        })();
    });
</script>
</body>
</html>
